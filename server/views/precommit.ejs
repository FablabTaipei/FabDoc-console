<!DOCTYPE html>
<html lang="en">

<head>
    <% include partials/head %>
        <script type="text/javascript" src="/client/js/socket.io.js"></script>
        <script type="text/javascript" src="/client/js/qrcode.min.js"></script>
        <script type="text/javascript" src="/client/js/sly.min.js"></script>
        <script type="text/javascript" src="/client/js/jquery.areaSelect.js"></script>
</head>

<body class="container">

    <header>
        <% include partials/header %>
    </header>

    <main>
        <div class="well">
            <button class="btn btn-default" onclick="preCommitBtnClick(this);">Start Pre-Commit</button>
            <p>Token: <span class="token"></span><canvas id="canvas"></canvas></p>
            <p>Status: <span class="status"></span></p>
        </div>
        <div class="col-xs-12 btn-push">
            <button class="btn btn-success pull-right" type="button">
                    Push <span class="badge">4</span>
                </button>
        </div>
        <div class="row">
            <div class="col-md-8">
                <div class="img-view"><img id="editor" src="" /></div>
                <div class="frame">
                    <ul class="slidee">
                    </ul>
                </div>
                <div class="scrollbar">
                    <div class="handle"></div>
                </div>
            </div>
            <div class="col-md-4">
                <form>
                    <h5><strong>Commit</strong></h5>
                    <div class="form-group form-commit">
                        <label for="inputCommit" class="sr-only">Commit</label>
                        <input type="text" class="form-control" id="inputCommit">
                    </div>
                    <h5><strong>Components</strong></h5>
                    <div class="form-group">
                        <div class="row">
                            <div class="col-xs-4">
                                <label for="inputAmount" class="sr-only">Amount</label>
                                <input type="number" class="form-control text-center" id="inputAmount" placeholder="quantity" />
                            </div>
                            <div class="col-xs-1">
                                <p class="form-control-static text-center"> x </p>
                            </div>
                            <div class="col-xs-7">
                                <label for="inputComponents" class="sr-only">Components</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="inputComponents" placeholder="name" />
                                    <span class="input-group-btn">
                                        <button type="submit" class="btn btn-default" type="button"><span class="glyphicon glyphicon-plus"></span></button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h5><strong>Machines</strong></h5>
                    <div class="form-group has-feedback">
                        <label for="inputMachines" class="sr-only">Machines</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="inputMachines" />
                            <span class="input-group-btn">
                                <button type="submit" class="btn btn-default" type="button"><span class="glyphicon glyphicon-plus"></span></button>
                            </span>
                        </div>
                    </div>
                    <h5><strong>Repository</strong></h5>
                    <div class="form-group has-feedback form-repo">
                        <label for="inputRepository" class="sr-only">Repository</label>
                        <div class="input-group">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-link"></span></span>
                            <input type="text" class="form-control" id="inputRepository" />
                            <span class="input-group-btn">
                                <button type="submit" class="btn btn-default" type="button"><span class="glyphicon glyphicon-plus"></span></button>
                            </span>
                        </div>
                    </div>
                    <h5><strong>Note</strong></h5>
                    <div class="form-group form-note">
                        <label for="inputNote" class="sr-only">Note</label>
                        <textarea class="form-control" id="inputNote"></textarea>
                    </div>
                </form>
            </div>
            <button type="submit" class="btn btn-primary pull-right btn-save">Save</button>
            <button type="submit" class="btn btn-default pull-right">Uncommit</button>
        </div>
        </div>

    </main>

    <footer>
        <% include partials/footer %>
    </footer>

    <script type="text/javascript">
        var tag_editor_options = {
            initAreas: [{
                "width": 500,
                "height": 500
            }],
            deleteMethod: 'click',
            area: {
                strokeStyle: '#E5E8E8',
                lineWidth: 1
            },
            point: {
                size: 0,
                fillStyle: 'black'
            },
        };

        // Setup a canvas to tag materials on pre-commit pictures
        $('#editor').areaSelect(tag_editor_options);

        $('#editor').areaSelect('bindChangeEvent', function(event, data) {
            console.log(data.areas);
        });

        var frame_options = {
            horizontal: 1,
            itemNav: 'centered',
            speed: 300,
            smart: 1,
            mouseDragging: 1,
            touchDragging: 1,
            releaseSwing: 1,
            activateOn: 'click',
            activateMiddle: 1,
            scrollBar: '.scrollbar',
            dragHandle: 1,
            dynamicHandle: 1,
            minHandleSize: 70,
            scrollBy: 10,
            clickBar: 1,
            elasticBounds: 1
        };

        var frame = new Sly('.frame', frame_options)

        frame.on('active', function(e, i) {
            // Show clicked activated image into preview editor
            var id = '#item-' + i;
            var newSrc = $(id).attr('src');
            $("#editor").attr('src', newSrc);
        });

        frame.init();

        $(window).resize(function(e) {
            $('.frame').sly('reload');
        });

        function preCommitBtnClick(o) {
            $(o).prop("disabled", true);

            socketInstance = io.connect();
            socketInstance.on('connect', function(msg) {
                console.log("Browser Connected.");
            });
            socketInstance.on('pass_token', function(data) {
                $(".well span.token").text(data.token);
                qrcodelib.toCanvas(document.getElementById('canvas'), data.token, function(error) {
                    if (error) console.error(error)
                    console.log('success!');
                });
            });
            socketInstance.on('pass_compressed_image', function(data) {
                var image = '<li>' + '<img id="item-' + frame.items.length + '" height="100%" src="data:' + data.type + ';base64,' + data.base64 + '"/>' + '</li>'
                frame.add(image);
                frame.activate(frame.items.length - 1);
            });
        }
    </script>
</body>

</html>
